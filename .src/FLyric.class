' Gambas class file

'
' Catalogador musical
' Catalogador de pistas de musica de varios formatos como ogg, mp3 etc. Es necesario tener instalado en el sistema la libreria exiftools y elinks.
'
' Copyright (C) Martín Belmonte
'
' This program is free software; you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation; either version 2 of the License, or
' (at your option) any later version.
'
' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.
'
' You should have received a copy of the GNU General Public License
' along with this program; if not, write to the Free Software
' Foundation, Inc., 51 Franklin St, Fifth Floor,
' Boston, MA  02110-1301  USA
'

Private strLyPath As String

Private strArt As String
Private strArtx As String
Private strAlb As String
Private strAlbx As String

Private strTit As String
Private strTitx As String

Private strLyric As String
Private strCCo As String
Private strCtr As String
Private strCtrx As String

Private strGen As String
Private strGenx As String

Private strDir As String

Private stxFileParts As New String[]

Private strState As String

Public Sub Form_Open()

  Dim strCoverPath As String
  Dim strYea As String
  Dim strFlagPath As String

  strState = "Loading"

  If Me.Tag <> Null Then
    If Me.Tag.Count > 0 Then
      strArt = Me.Tag[0]
      strArtx = Me.Tag[1]

      strAlb = Me.Tag[2]
      strAlbx = Me.Tag[3]

      strYea = Me.Tag[4]

      strTit = Me.Tag[5]
      strTitx = Me.Tag[6]

      strCCo = Me.Tag[7]
      strCtr = Me.Tag[8]
      strCtrx = Me.Tag[9]

      strGen = Me.Tag[10]
      strGenx = Me.Tag[11]

      strDir = Me.Tag[12]
    Endif
  Endif

  lblArtist.Text = ("Artista") & ": " ' & strArt
  btoArtist.Text = strArt

  lblAlbum.Text = ("Álbum") & ": " '& strAlb & " [" & strYea & "]"
  btoAlbum.Text = strAlb & " [" & strYea & "]"

  lblTitle.Text = ("Título") & ": " ' & strTit
  btoATitle.Text = strTit

  If Exist(strDir) Then
    If Stat(strDir).Type = gb.Directory Then ' Directorio validado
      stxFileParts.Add(strArt)
      stxFileParts.Add(strTit)

      ' Carga de la tapa del disco
      strCoverPath = strDir &/ "cover.jpg"

      If Exist(strCoverPath) Then
        If Stat(strCoverPath).Type = gb.File Then
          pioCover.Picture = Picture.Load(strCoverPath)

        Endif
      Else
        pioCover.Picture = Picture.Load("logo.png")
      Endif

      ' Carga de la bandera del pais del artista

      strFlagPath = "flags" &/ String.LCase(strCCo) & ".png"

      If Exist(strFlagPath) Then
        If Stat(strFlagPath).Type = gb.File Then
          'pioFlag.Picture = Picture.Load(strFlagPath)
          btoArtist.Picture = Picture.Load(strFlagPath)
        Endif
      Else
        'pioFlag.Picture = Picture["icon:/22/flag"]
        btoArtist.Picture = Picture["icon:/22/flag"]
      Endif

      ' Carga de la letra de la cancion
      strLyPath = FMain.strLyricDir &/ MUtility.FileNospace(stxFileParts, "#", "txt")
      If Exist(strLyPath) Then
        If Stat(strLyPath).Type = gb.File Then
          strLyric = File.Load(strLyPath)
          txaLyric.Text = strLyric

        Endif
      Endif
    Endif
  Endif

End

Public Sub tobSave_Click()

  File.Save(strLyPath, txaLyric.Text)

End

Public Sub tobLyric_Click()

  If strArt <> "" And strAlb <> "" Then
    MHttp.OpenLyricWeb(strArt, strTit)
  Endif

End

Public Sub tobWiki_Click()

  If strArt <> "" Then
    MHttp.OpenArtistWeb(strArt, "wikipedia")
  Endif

End

Public Sub btoArtist_Click()

  Dim frmArtist As New FArtist
  '  Dim stxDataArtist As New String[]

  frmArtist.X = btoArtist.ScreenX + btoArtist.Width
  frmArtist.Y = btoArtist.ScreenY
  frmArtist.Title = ("Ficha del Artista")

  frmArtist.Tag = CInt(strArtx)

  frmArtist.Show()

  strState = "Loaded"

End

Public Sub btoAlbum_Click()

  Print strAlb & "[" & strAlbx & "]"

End

Public Sub btoATitle_Click()

  Print strTit & "[" & strTitx & "]"

End

Public Sub btoArtist_Change()

  Dim intKey As Integer
  Dim resArtista As Result

  If strState = "Loaded" Then
    intKey = Me.Tag[1]

    resArtista = FMain.conDB.Edit("artist", "artistindx=&1", intKey)
    resArtista["artistcountry"] = MUtility.GetForeignKey(btoArtist.Text, FMain.conDB, "country", "ctryindx", "ctryname")
    resArtista.update

  Endif

End
